# HubSpot Integration Readme

This document walks through the current set of HubSpot integration changes that are still unstaged in the working tree. It explains what each modified file contributes and, for code-heavy files, what each major method does. Use this as a technical companion while polishing the integration or preparing a pull request.

---

## 1. Data model and persistence

### `db/migrate/20250930093010_create_hubspot_integrations.rb`
Creates the `hubspot_integrations` table used to store per-account OAuth details.
- Defines foreign keys to `companies` (required) and `users` (optional).
- Persists OAuth tokens (`access_token`, `refresh_token`, `expires_at`), account metadata (`portal_id`, `account_name`, `connected_at`), and a JSONB `settings` column for feature toggles (e.g., auto-validate per list).
- Records are destroyed on disconnect (no `disconnected_at` column).
- Adds a composite index on `[:company_id, :portal_id]` to prevent duplicate portals per company.

### `db/schema.rb`
The schema snapshot now reflects:
- The new `hubspot_integrations` table and indices.
- An extra `refunded_credits` counter on `companies`, `deleted_at` columns moved to the end on a few soft-deleted tables, and the `status_counts` JSONB column on `documents` (generated by migrations already run). These appear because the migration was executed locally.

### `app/models/company.rb`
Adds associations and helpers to manage multiple HubSpot connections:
- `has_many :hubspot_integrations` with dependent destroy.
- `has_one :hubspot_integration` scope that returns the most recently connected account (preserves legacy `company.hubspot_integration` access).
- `build_hubspot_integration` convenience builder for forms/concerns.

### `app/models/hubspot_integration.rb`
Represents a single HubSpot account connection.
- `belongs_to :company` / `belongs_to :user` (user required by validation).
- Records are destroyed on disconnect (no soft-delete).
- Validation `portal_not_connected_elsewhere` prevents the same portal ID from associating with multiple companies simultaneously.
- `connected?` helper checks for presence of access_token and portal_id, and `write_back_enabled?` currently always returns `true` (placeholder for future feature gating).
- `list_ids` accessor exposes any legacy list IDs stored in the `settings` JSON.

### `app/models/document.rb`
Expands the `source` enum with `:hubspot` so imported lists can be tagged. This flag is later used by background jobs when deciding whether to sync results back to HubSpot.

---

## 2. Controllers and routing

### `config/routes.rb`
Adds a dedicated HubSpot namespace under `/integrations/hubspot`:
- `GET /integrations/hubspot` → show page.
- `GET /integrations/hubspot/connect` → start OAuth.
- `GET /integrations/hubspot/callback` → OAuth return handler.
- `DELETE /integrations/hubspot/disconnect` → revoke active account.
- `GET /integrations/hubspot/switch_account` → pick a different connected account.
- `POST /integrations/hubspot/toggle_auto_validate` → enable/disable auto-validate on a list.
- `GET /integrations/hubspot/lists` → JSON feed of HubSpot lists and counts.
- `POST /integrations/hubspot/validate` → trigger manual validation job.
- `POST /webhooks/hubspot` → webhook endpoint for contact events.

### `app/controllers/integrations_controller.rb`
Now includes `HubspotIntegrationConcern` so the controller inherits all HubSpot actions (listed above). The `index` and `zap_it` placeholders remain unchanged.

### `app/controllers/concerns/hubspot_integration_concern.rb`
Centralizes HubSpot controller logic. Key public actions:
- `hubspot_show` – renders the integration dashboard view.
- `hubspot_connect` – redirects to HubSpot OAuth consent.
- `hubspot_callback` – exchanges OAuth code, stores tokens, handles account switching, ensures custom properties, and notifies the user via ActionCable.
- `hubspot_disconnect` – destroys the active integration record (freeing the portal for use elsewhere), clears session state, and broadcasts a toast.
- `hubspot_switch_account` – toggles between existing connections or starts a fresh connect flow.
- `toggle_auto_validate` – flips per-list auto-validation flags inside the integration’s `settings` JSON.
- `hubspot_lists` – aggregates HubSpot list metadata and current EmailVerify settings for the Stimulus controller.
- `hubspot_validate` – bulk-imports contacts from selected HubSpot lists, creates a `Document`, consumes credits, and enqueues verification.

Important private helpers:
- `set_company` – ensures the user has an active company.
- `set_hubspot_integration` / `set_or_build_hubspot_integration` – manage the active integration and the session bookmark.
- `hubspot_client` – memoizes an `Ev::HubspotClient` instance.
- `consume_hubspot_credits!` – wraps credit consumption with metadata tagging.
- `update_list_settings` – timestamps list validations and stores them in settings.
- `build_token_attributes` – shapes OAuth token hashes for persistence.
- `handle_account_switch!` – resolves duplicate portals across companies, syncs account names, and guards against cross-company reuse.
- `ensure_required_properties` – asks the API client to create the EmailVerify custom properties.
- `switch_to_existing_account` – handles session switching when the user selects another integration from the dropdown.
- `build_hubspot_document` – creates a `Document` that records the import and triggers background processing.

### `app/controllers/webhooks_controller.rb`
Adds a `hubspot` endpoint that receives contact change webhooks:
- Logs the incoming portal ID and signature (full verification TBD).
- Filters out events unless the company has at least one auto-validate list enabled.
- Ensures the event pertains to contacts and that an email is present (fallback fetch via API when necessary).
- Enqueues `HubspotAutoValidateWorker` to validate the contact asynchronously.
- Private helpers: `verify_hubspot_signature` (currently logs the signature) and `process_hubspot_event` / `fetch_contact_email` implement the filtering, email lookup, and job enqueueing pipeline.

---

## 3. Background processing

### `app/sidekiq/hubspot_auto_validate_worker.rb`
Validates a single HubSpot contact when prompted by the webhook flow.
- `perform(integration_id, contact_id, email)` – loads integration, checks/consumes one credit, calls `EmailVerificationService`, and pushes the result back to HubSpot. Unknown statuses trigger a credit refund.
- `push_result_to_hubspot` (private) – syncs EmailVerify properties on the given contact, handling API errors gracefully.

### `app/jobs/hubspot_push_results_job.rb`
Pushes bulk verification results back to HubSpot after a manual import finishes.
- `perform(document_id)` – validates prerequisites, instantiates `Ev::HubspotClient`, ensures properties exist, and updates each verified email from the document.
- `push_email_result_to_hubspot` – finds or creates a contact, updates EmailVerify properties, and logs refreshed values.

### `app/sidekiq/bulk_email_verification_worker.rb`
Inside `finish_verification`, adds logic to schedule `HubspotPushResultsJob` whenever a verified document came from HubSpot and write-back is enabled. This ties the bulk verification flow to post-processing sync.

---

## 4. HubSpot API client (`app/services/ev/hubspot_client.rb`)
Encapsulates all HubSpot REST calls. Public methods:
- `initialize(integration)` – remembers the integration record for tokens/settings.
- `authorization_url` – builds the OAuth consent URL.
- `exchange_code_for_tokens(code)` – swaps an auth code for access & refresh tokens.
- `refresh_tokens!` – refreshes access tokens when near expiry.
- `account_info` – fetches portal ID and account name for the current tokens.
- `ensure_properties!(force: false)` – guarantees that EmailVerify custom properties exist (with retry/disable logic).
- `lists` – returns all HubSpot contact lists with counts.
- `total_contacts` / `count_new_contacts(list_id)` – count helper APIs used by the UI.
- `fetch_contacts(list_id:, verify_new_only:)` – returns contacts for manual validation, optionally filtering to “new” (no EmailVerify status yet).
- `fetch_contact_email(contact_id)` – fetches a single contact’s email, used in webhook fallbacks.
- `find_contact_by_email(email)` – layered lookup using v3 search, archived objects, and legacy v1 endpoints.
- `update_contact(contact_id, properties)` – patches EmailVerify properties, falling back if custom properties are unavailable.
- `reload_contact(contact_id)` – reloads a contact after an update for logging.
- `create_contact(email, properties)` – creates a new contact or resolves conflicts if it already exists.

Notable private helpers (grouped by responsibility):
- **Property provisioning**: `fetch_existing_property_names`, `create_property`, `mark_custom_properties_supported!`, `disable_custom_properties!`, `reenable_custom_properties!`, `persist_custom_property_flag` keep track of whether custom properties are allowed.
- **Searching & pagination**: `paginate_search`, `count_contacts`, `build_filter_groups`, `search_payload` power list queries.
- **Contact lookup variants**: `search_contact_by_email`, `fetch_contact_by_identifier`, `fetch_contact_by_id`, `fetch_contact_by_legacy_email`, `search_contact_by_legacy_query`, `normalize_contact`, `restore_contact`, `contact_email_matches?` cover different API surfaces and archival states.
- **HTTP plumbing**: `get`, `post`, `patch`, `auth_headers`, `contact_url`, `parse`, `build_url` wrap RestClient and automatic token refresh.
- **Error handling & logging**: `attempt_lookup`, `log_lookup_result`, `log_lookup_http_error`, `log_create_error`, `extract_conflict_id`, `log_update_error` standardize diagnostics.
- **Property filtering**: `sanitize_properties`, `remove_custom_properties`, `custom_property?`, `property_missing?` guard against API limitations.
- **Misc**: `default_account_name` provides a fallback for UI messages.

---

## 5. Front-end experience

### `app/views/integrations/hubspot.html.erb`
Renders the HubSpot integration dashboard:
- Always attaches the Stimulus controller with URLs injected when connected.
- Displays connection status, account selector, and disconnect button.
- Shows a form for manual list validation with a table populated via Stimulus.
- Includes auto-validate toggles, “verify new only” option, and last validation timestamps.
- Provides onboarding copy when no account is connected.

### `app/javascript/controllers/hubspot_integration_controller.js`
Stimulus controller orchestrating the HubSpot dashboard.
- Targets: form fields, account selector, table body, etc.
- Values: URLs for list fetch, toggle endpoint, connect and switch routes.
- Lifecycle: `connect` wires event listeners and triggers an initial fetch; `disconnect` removes them.
- Event handlers: `handleAccountSwitch`, `handleSelectAll`, `handleVerifyNewOnlyChange`, `handleAutoValidateToggle`.
- Data loading: `loadLists` fetches JSON and handles spinners/errors; `renderLists` builds table rows and wires up child listeners.
- State helpers: `updateFormState`, `updateCountsDisplay`, `selectedListIds`, `selectedContactsCount` enable the CTA button and counts.
- Utility helpers: DOM queries, CSRF token lookup, HTML escaping, and `formatTimeAgo` for timestamps.

### `app/javascript/controllers/index.js`
Registers the new Stimulus controller under the `hubspot-integration` identifier.

---

## 6. Views, helpers, and misc.

### `app/helpers/integrations_helper.rb`
Adds a “HubSpot (Direct)” entry to the integrations grid so the UI links to the new dashboard.

### `app/views/integrations/hubspot.html.erb`
(See section 5 for details; listed here because it is an unstaged file.)

### `config/routes.rb`
(See section 2 for route inventory; included again for completeness.)

---

## 7. Usage flow recap

1. Users visit `/integrations/hubspot`, connect via OAuth, and choose the account from the new dropdown (handled by `HubspotIntegrationConcern`).
2. The Stimulus controller (`hubspot_integration_controller.js`) loads lists via `hubspot_lists`, presenting contact counts and auto-validate toggles.
3. Manual validation submits to `hubspot_validate`, which imports contacts into a HubSpot-sourced `Document` and queues bulk verification.
4. When verification finishes, `BulkEmailVerificationWorker` schedules `HubspotPushResultsJob` to push statuses back to HubSpot.
5. Webhooks hitting `/webhooks/hubspot` spawn `HubspotAutoValidateWorker`, validating single contacts in real time when auto-validate is toggled on.

---

## 8. Outstanding considerations

- Signature verification for webhooks is logged but not yet enforced (`verify_hubspot_signature`).
- The README reflects only files currently unstaged; re-run the walkthrough if additional files change.
- Ensure refreshed tokens (`refresh_tokens!`) and property provisioning logic are covered by tests before shipping.
